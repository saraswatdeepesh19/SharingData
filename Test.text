@Service
public class HealthCheckService {

    @Autowired
    private ServiceHealthRepository serviceHealthRepository;

    @Autowired
    private RestTemplate restTemplate;

    public ServiceHealth saveServiceHealth(ServiceHealth serviceHealth) {
        return serviceHealthRepository.save(serviceHealth);
    }

    public List<ServiceHealthStatus> checkAllServiceHealth() {
        List<ServiceHealth> services = serviceHealthRepository.findAll();
        List<ServiceHealthStatus> statuses = new ArrayList<>();

        for (ServiceHealth service : services) {
            ResponseEntity<String> response;
            try {
                response = restTemplate.getForEntity(service.getHealthUrl(), String.class);
                statuses.add(new ServiceHealthStatus(service.getServiceName(), response.getStatusCode().toString()));
            } catch (Exception e) {
                statuses.add(new ServiceHealthStatus(service.getServiceName(), "DOWN"));
            }
        }

        return statuses;
    }
}
