package com.example.monitoring.controller;

import com.example.monitoring.service.ActiveSessionService;
import com.example.monitoring.service.ThirdPartyLocationService;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;

@RestController
public class SessionController {

    private final ActiveSessionService sessionService;
    private final ThirdPartyLocationService locationService;

    public SessionController(ActiveSessionService sessionService, ThirdPartyLocationService locationService) {
        this.sessionService = sessionService;
        this.locationService = locationService;
    }

    /**
     * Handles the user login request.
     * API: POST /api/login?userId={userId}
     */
    @PostMapping("/api/login")
    public ResponseEntity<String> login(
            @RequestParam("userId") String userId) { 

        // 1. Get location from third-party/User Management API using ONLY the userId.
        String location = locationService.getLocationByUserId(userId);

        // 2. Handle session and metrics (DB interaction, Prometheus updates)
        sessionService.login(userId, location);

        return ResponseEntity.ok(
            String.format("Login successful for user: %s from location: %s", userId, location)
        );
    }

    /**
     * Handles the user logout request.
     * API: POST /api/logout?userId={userId}
     */
    @PostMapping("/api/logout")
    public ResponseEntity<String> logout(@RequestParam("userId") String userId) {
        
        // 1. Handle session and metrics (DB interaction, Prometheus updates)
        sessionService.logout(userId);
        
        return ResponseEntity.ok("Logout successful for user: " + userId);
    }
}
